"use strict";const A=require("electron"),B=require("path"),fe=require("child_process"),b=require("fs"),Ue=require("steamworks.js"),be=require("stream/promises"),Me=require("stream"),Fe=require("zlib"),Be=require("crypto");let v=null,U=null;function He(){try{v=Ue.init(40970),console.log("Steam initialized:",v.localplayer.getName()),console.log("Client keys:",Object.keys(v)),console.log("Localplayer keys:",Object.keys(v.localplayer))}catch(i){console.error("Failed to initialize Steam:",i)}}function Ze(){A.ipcMain.handle("get-steam-user",()=>v?{name:v.localplayer.getName(),steamId:v.localplayer.getSteamId().steamId64.toString()}:null),A.ipcMain.handle("get-auth-ticket",async()=>{if(!v)throw new Error("Steam not initialized");try{return(await v.auth.getAuthTicketForWebApi("LobbyClient")).getBytes().toString("hex")}catch(i){return console.error("Failed to get auth ticket:",i),null}}),A.ipcMain.handle("get-steam-friends",()=>v?v.friends?v.friends.getFriends(4).map(e=>({id:e.getSteamId().steamId64.toString(),name:e.getName(),status:e.getPersonaState(),avatar:e.getMediumAvatarUrl()})):(console.warn("Steam Friends interface not available in this version of steamworks.js"),[{id:"76561198000000001",name:"Sir William (Mock)",status:1,avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=William"},{id:"76561198000000002",name:"The Snake (Mock)",status:6,avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=Snake"},{id:"76561198000000003",name:"The Rat (Mock)",status:0,avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=Rat"}]):[]),A.ipcMain.handle("steam-create-lobby",async(i,e=8,a="Lobby",E="crusader")=>{if(!v)throw new Error("Steam not initialized");try{return U=await v.matchmaking.createLobby(2,e),console.log("Created lobby:",U.id),U.setData("name",a)||console.warn("Failed to set lobby name"),U.setData("gameMode",E)||console.warn("Failed to set game mode"),U.setData("status","Open"),U.setData("status","Open"),{id:U.id.toString(),owner:U.getOwner().steamId64.toString(),name:a,gameMode:E}}catch(g){throw console.error("Failed to create lobby:",g),g}}),A.ipcMain.handle("steam-get-lobbies",async()=>{if(!v)return[];try{return(await v.matchmaking.getLobbies()).map(e=>{const a=e.getFullData(),g=a.__gameserverSteamID&&a.__gameserverSteamID!=="0"||e.getData("status")==="In Game",h=e.getOwner(),l=h.steamId64.toString();let f=l;try{f=v.friends.getFriendPersonaName(h)||l}catch{console.warn("Failed to get persona name for lobby owner:",l)}return{id:e.id.toString(),owner:l,ownerName:f,memberCount:e.getMemberCount(),maxMembers:e.getMemberLimit(),name:e.getData("name")||"Unnamed Lobby",gameMode:e.getData("gameMode")||"crusader",isInGame:g}})}catch(i){return console.error("Failed to get lobbies:",i),[]}}),A.ipcMain.handle("steam-join-lobby",async(i,e)=>{if(!v)throw new Error("Steam not initialized");try{return console.log("Joining lobby:",e),U=await v.matchmaking.joinLobby(BigInt(e)),{id:U.id.toString(),owner:U.getOwner().steamId64.toString()}}catch(a){throw console.error("Failed to join lobby:",a),a}}),A.ipcMain.handle("steam-set-lobby-data",async(i,e,a)=>{if(!U)throw new Error("Not in a lobby");try{return U.setData(e,a)}catch(E){return console.error("Failed to set lobby data:",E),!1}}),A.ipcMain.handle("steam-leave-lobby",async()=>{U&&(console.log("Leaving lobby:",U.id),await U.leave(),U=null)}),A.ipcMain.handle("steam-get-lobby-members",async()=>{if(!U)return[];try{const i=U.getMembers(),e=[];for(const a of i){const E=a.steamId64;if(!E||E.toString()==="0")continue;let g=E.toString();if(v.localplayer&&E===v.localplayer.getSteamId().steamId64)g=v.localplayer.getName();else try{const h=U.getMemberData(E,"name");h&&(g=h)}catch{}e.push({id:E.toString(),name:g})}return e}catch(i){return console.error("Failed to get lobby members:",i),[]}}),A.ipcMain.handle("steam-send-lobby-chat",async(i,e)=>{if(!U)throw new Error("Not in a lobby");try{const a=U.sendChatMsg(e);return a||console.error("Failed to send lobby chat message"),a}catch(a){throw console.error("Error sending lobby chat:",a),a}}),A.ipcMain.handle("steam-setup-lobby-chat-listener",async()=>{if(!U||!v)return!1;try{return v.matchmaking.on("lobby-chat-message",(i,e,a)=>{if(U&&i.toString()===U.id.toString()){let E=e.steamId64.toString();if(v.localplayer&&e.steamId64===v.localplayer.getSteamId().steamId64)E=v.localplayer.getName();else try{const h=U.getMemberData(e.steamId64,"name");h&&(E=h)}catch{}const g=A.BrowserWindow.getAllWindows();g.length>0&&g[0].webContents.send("lobby-chat-message",{senderId:e.steamId64.toString(),senderName:E,message:a,timestamp:new Date().toISOString()})}}),!0}catch(i){return console.error("Error setting up lobby chat listener:",i),!1}})}function ze(){if(!v)return console.error("getGameInstallDir: Client is null"),null;try{console.log("getGameInstallDir: Attempting to get install dir for 40970");const i=v.apps.appInstallDir(40970);return console.log("getGameInstallDir: Result:",i),i}catch(i){return console.error("getGameInstallDir: Failed to get install dir:",i),null}}let q=null;function Pe(i){q=i}function Ge(){A.ipcMain.handle("select-game-path",async()=>{const i=await A.dialog.showOpenDialog({properties:["openFile"],filters:[{name:"Executables",extensions:["exe"]}]});return!i.canceled&&i.filePaths.length>0?i.filePaths[0]:null}),A.ipcMain.handle("launch-game",async(i,e,a)=>{if(!b.existsSync(e))throw new Error("Game executable not found");const E=a.split(" ").filter(h=>h.length>0),g=B.dirname(e);console.log(`Launching game: "${e}" with args: ${E} in ${g}`);try{const h=fe.spawn(`"${e}"`,E,{cwd:g,detached:!0,shell:!0,stdio:"ignore",windowsVerbatimArguments:!0});return h.on("error",l=>{console.error("Failed to start game:",l)}),h.on("close",l=>{console.log(`Game process closed with code ${l}`),q&&q.webContents.send("game-exited",l)}),h.unref(),{success:!0}}catch(h){return console.error("Launch error:",h),{success:!1,error:h.message}}}),A.ipcMain.handle("launch-steam-game",async(i,e,a="crusader",E)=>{let g=null,h=null;if(E&&b.existsSync(E)?(console.log("Using custom game path:",E),h=E,g=B.dirname(E)):(console.log("Attempting to auto-detect game path..."),g=ze()),!g&&!h){console.error("Could not detect game install directory");const n=`steam://run/40970//${encodeURIComponent(e).replace(/%2B/g,"+")}`;console.log("Fallback to Steam URL:",n);try{return await A.shell.openExternal(n),{success:!0}}catch(m){return{success:!1,error:m.message}}}if(!h){const f=a==="extreme"?"Stronghold_Crusader_Extreme.exe":"Stronghold Crusader.exe";h=B.join(g,f),console.log("Auto-detected game path:",h,"(Mode:",a,")")}if(!b.existsSync(h))return console.error("Executable not found at:",h),{success:!1,error:`Executable not found: ${h}`};const l=e.split(" ").filter(f=>f.length>0);l.push("--ucp-verbosity 10"),l.push("--ucp-no-security"),console.log("Launching with arguments:",e,"-> Array:",l);try{const f=fe.spawn(`"${h}"`,l,{cwd:g||B.dirname(h),detached:!0,shell:!0,stdio:"ignore",windowsVerbatimArguments:!0});return f.on("close",n=>{console.log(`Steam Game process closed with code ${n}`),q&&q.webContents.send("game-exited",n)}),f.unref(),{success:!0}}catch(f){return console.error("Launch error:",f),{success:!1,error:f.message}}})}function je(){A.ipcMain.handle("download-file",async(i,e,a,E)=>{try{console.log(`Starting download: ${e} -> ${a}`);let g="";B.isAbsolute(E)?g=E:E==="maps"?g=B.join(A.app.getPath("documents"),"Stronghold Crusader","Maps"):E==="ucp"?g=B.join(A.app.getPath("userData"),"UCP"):g=B.join(A.app.getPath("downloads")),b.existsSync(g)||b.mkdirSync(g,{recursive:!0});const h=B.join(g,a),l=await fetch(e);if(!l.ok)throw new Error(`Failed to fetch ${e}: ${l.statusText}`);if(!l.body)throw new Error("No response body");const f=Me.Readable.fromWeb(l.body);return await be.pipeline(f,b.createWriteStream(h)),console.log(`Download complete: ${h}`),{success:!0,path:h}}catch(g){return console.error("Download error:",g),{success:!1,error:g.message}}})}function qe(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var P={exports:{}},K,le;function Te(){return le||(le=1,K={LOCHDR:30,LOCSIG:67324752,LOCVER:4,LOCFLG:6,LOCHOW:8,LOCTIM:10,LOCCRC:14,LOCSIZ:18,LOCLEN:22,LOCNAM:26,LOCEXT:28,EXTSIG:134695760,EXTHDR:16,EXTCRC:4,EXTSIZ:8,EXTLEN:12,CENHDR:46,CENSIG:33639248,CENVEM:4,CENVER:6,CENFLG:8,CENHOW:10,CENTIM:12,CENCRC:16,CENSIZ:20,CENLEN:24,CENNAM:28,CENEXT:30,CENCOM:32,CENDSK:34,CENATT:36,CENATX:38,CENOFF:42,ENDHDR:22,ENDSIG:101010256,ENDSUB:8,ENDTOT:10,ENDSIZ:12,ENDOFF:16,ENDCOM:20,END64HDR:20,END64SIG:117853008,END64START:4,END64OFF:8,END64NUMDISKS:16,ZIP64SIG:101075792,ZIP64HDR:56,ZIP64LEAD:12,ZIP64SIZE:4,ZIP64VEM:12,ZIP64VER:14,ZIP64DSK:16,ZIP64DSKDIR:20,ZIP64SUB:24,ZIP64TOT:32,ZIP64SIZB:40,ZIP64OFF:48,ZIP64EXTRA:56,STORED:0,SHRUNK:1,REDUCED1:2,REDUCED2:3,REDUCED3:4,REDUCED4:5,IMPLODED:6,DEFLATED:8,ENHANCED_DEFLATED:9,PKWARE:10,BZIP2:12,LZMA:14,IBM_TERSE:18,IBM_LZ77:19,AES_ENCRYPT:99,FLG_ENC:1,FLG_COMP1:2,FLG_COMP2:4,FLG_DESC:8,FLG_ENH:16,FLG_PATCH:32,FLG_STR:64,FLG_EFS:2048,FLG_MSK:4096,FILE:2,BUFFER:1,NONE:0,EF_ID:0,EF_SIZE:2,ID_ZIP64:1,ID_AVINFO:7,ID_PFS:8,ID_OS2:9,ID_NTFS:10,ID_OPENVMS:12,ID_UNIX:13,ID_FORK:14,ID_PATCH:15,ID_X509_PKCS7:20,ID_X509_CERTID_F:21,ID_X509_CERTID_C:22,ID_STRONGENC:23,ID_RECORD_MGT:24,ID_X509_PKCS7_RL:25,ID_IBM1:101,ID_IBM2:102,ID_POSZIP:18064,EF_ZIP64_OR_32:4294967295,EF_ZIP64_OR_16:65535,EF_ZIP64_SUNCOMP:0,EF_ZIP64_SCOMP:8,EF_ZIP64_RHO:16,EF_ZIP64_DSN:24}),K}var $={},ue;function ce(){return ue||(ue=1,(function(i){const e={INVALID_LOC:"Invalid LOC header (bad signature)",INVALID_CEN:"Invalid CEN header (bad signature)",INVALID_END:"Invalid END header (bad signature)",DESCRIPTOR_NOT_EXIST:"No descriptor present",DESCRIPTOR_UNKNOWN:"Unknown descriptor format",DESCRIPTOR_FAULTY:"Descriptor data is malformed",NO_DATA:"Nothing to decompress",BAD_CRC:"CRC32 checksum failed {0}",FILE_IN_THE_WAY:"There is a file in the way: {0}",UNKNOWN_METHOD:"Invalid/unsupported compression method",AVAIL_DATA:"inflate::Available inflate data did not terminate",INVALID_DISTANCE:"inflate::Invalid literal/length or distance code in fixed or dynamic block",TO_MANY_CODES:"inflate::Dynamic block code description: too many length or distance codes",INVALID_REPEAT_LEN:"inflate::Dynamic block code description: repeat more than specified lengths",INVALID_REPEAT_FIRST:"inflate::Dynamic block code description: repeat lengths with no first length",INCOMPLETE_CODES:"inflate::Dynamic block code description: code lengths codes incomplete",INVALID_DYN_DISTANCE:"inflate::Dynamic block code description: invalid distance code lengths",INVALID_CODES_LEN:"inflate::Dynamic block code description: invalid literal/length code lengths",INVALID_STORE_BLOCK:"inflate::Stored block length did not match one's complement",INVALID_BLOCK_TYPE:"inflate::Invalid block type (type == 3)",CANT_EXTRACT_FILE:"Could not extract the file",CANT_OVERRIDE:"Target file already exists",DISK_ENTRY_TOO_LARGE:"Number of disk entries is too large",NO_ZIP:"No zip file was loaded",NO_ENTRY:"Entry doesn't exist",DIRECTORY_CONTENT_ERROR:"A directory cannot have content",FILE_NOT_FOUND:'File not found: "{0}"',NOT_IMPLEMENTED:"Not implemented",INVALID_FILENAME:"Invalid filename",INVALID_FORMAT:"Invalid or unsupported zip format. No END header found",INVALID_PASS_PARAM:"Incompatible password parameter",WRONG_PASSWORD:"Wrong Password",COMMENT_TOO_LONG:"Comment is too long",EXTRA_FIELD_PARSE_ERROR:"Extra field parsing error"};function a(E){return function(...g){return g.length&&(E=E.replace(/\{(\d)\}/g,(h,l)=>g[l]||"")),new Error("ADM-ZIP: "+E)}}for(const E of Object.keys(e))i[E]=a(e[E])})($)),$}var Y,de;function Ve(){if(de)return Y;de=1;const i=b,e=B,a=Te(),E=ce(),g=typeof process=="object"&&process.platform==="win32",h=n=>typeof n=="object"&&n!==null,l=new Uint32Array(256).map((n,m)=>{for(let D=0;D<8;D++)(m&1)!==0?m=3988292384^m>>>1:m>>>=1;return m>>>0});function f(n){this.sep=e.sep,this.fs=i,h(n)&&h(n.fs)&&typeof n.fs.statSync=="function"&&(this.fs=n.fs)}return Y=f,f.prototype.makeDir=function(n){const m=this;function D(p){let y=p.split(m.sep)[0];p.split(m.sep).forEach(function(d){if(!(!d||d.substr(-1,1)===":")){y+=m.sep+d;var S;try{S=m.fs.statSync(y)}catch{m.fs.mkdirSync(y)}if(S&&S.isFile())throw E.FILE_IN_THE_WAY(`"${y}"`)}})}D(n)},f.prototype.writeFileTo=function(n,m,D,p){const y=this;if(y.fs.existsSync(n)){if(!D)return!1;var d=y.fs.statSync(n);if(d.isDirectory())return!1}var S=e.dirname(n);y.fs.existsSync(S)||y.makeDir(S);var C;try{C=y.fs.openSync(n,"w",438)}catch{y.fs.chmodSync(n,438),C=y.fs.openSync(n,"w",438)}if(C)try{y.fs.writeSync(C,m,0,m.length,0)}finally{y.fs.closeSync(C)}return y.fs.chmodSync(n,p||438),!0},f.prototype.writeFileToAsync=function(n,m,D,p,y){typeof p=="function"&&(y=p,p=void 0);const d=this;d.fs.exists(n,function(S){if(S&&!D)return y(!1);d.fs.stat(n,function(C,F){if(S&&F.isDirectory())return y(!1);var w=e.dirname(n);d.fs.exists(w,function(L){L||d.makeDir(w),d.fs.open(n,"w",438,function(_,o){_?d.fs.chmod(n,438,function(){d.fs.open(n,"w",438,function(t,c){d.fs.write(c,m,0,m.length,0,function(){d.fs.close(c,function(){d.fs.chmod(n,p||438,function(){y(!0)})})})})}):o?d.fs.write(o,m,0,m.length,0,function(){d.fs.close(o,function(){d.fs.chmod(n,p||438,function(){y(!0)})})}):d.fs.chmod(n,p||438,function(){y(!0)})})})})})},f.prototype.findFiles=function(n){const m=this;function D(p,y,d){let S=[];return m.fs.readdirSync(p).forEach(function(C){const F=e.join(p,C),w=m.fs.statSync(F);S.push(e.normalize(F)+(w.isDirectory()?m.sep:"")),w.isDirectory()&&d&&(S=S.concat(D(F,y,d)))}),S}return D(n,void 0,!0)},f.prototype.findFilesAsync=function(n,m){const D=this;let p=[];D.fs.readdir(n,function(y,d){if(y)return m(y);let S=d.length;if(!S)return m(null,p);d.forEach(function(C){C=e.join(n,C),D.fs.stat(C,function(F,w){if(F)return m(F);w&&(p.push(e.normalize(C)+(w.isDirectory()?D.sep:"")),w.isDirectory()?D.findFilesAsync(C,function(L,_){if(L)return m(L);p=p.concat(_),--S||m(null,p)}):--S||m(null,p))})})})},f.prototype.getAttributes=function(){},f.prototype.setAttributes=function(){},f.crc32update=function(n,m){return l[(n^m)&255]^n>>>8},f.crc32=function(n){typeof n=="string"&&(n=Buffer.from(n,"utf8"));let m=n.length,D=-1;for(let p=0;p<m;)D=f.crc32update(D,n[p++]);return~D>>>0},f.methodToString=function(n){switch(n){case a.STORED:return"STORED ("+n+")";case a.DEFLATED:return"DEFLATED ("+n+")";default:return"UNSUPPORTED ("+n+")"}},f.canonical=function(n){if(!n)return"";const m=e.posix.normalize("/"+n.split("\\").join("/"));return e.join(".",m)},f.zipnamefix=function(n){if(!n)return"";const m=e.posix.normalize("/"+n.split("\\").join("/"));return e.posix.join(".",m)},f.findLast=function(n,m){if(!Array.isArray(n))throw new TypeError("arr is not array");const D=n.length>>>0;for(let p=D-1;p>=0;p--)if(m(n[p],p,n))return n[p]},f.sanitize=function(n,m){n=e.resolve(e.normalize(n));for(var D=m.split("/"),p=0,y=D.length;p<y;p++){var d=e.normalize(e.join(n,D.slice(p,y).join(e.sep)));if(d.indexOf(n)===0)return d}return e.normalize(e.join(n,e.basename(m)))},f.toBuffer=function(m,D){return Buffer.isBuffer(m)?m:m instanceof Uint8Array?Buffer.from(m):typeof m=="string"?D(m):Buffer.alloc(0)},f.readBigUInt64LE=function(n,m){var D=Buffer.from(n.slice(m,m+8));return D.swap64(),parseInt(`0x${D.toString("hex")}`)},f.fromDOS2Date=function(n){return new Date((n>>25&127)+1980,Math.max((n>>21&15)-1,0),Math.max(n>>16&31,1),n>>11&31,n>>5&63,(n&31)<<1)},f.fromDate2DOS=function(n){let m=0,D=0;return n.getFullYear()>1979&&(m=(n.getFullYear()-1980&127)<<9|n.getMonth()+1<<5|n.getDate(),D=n.getHours()<<11|n.getMinutes()<<5|n.getSeconds()>>1),m<<16|D},f.isWin=g,f.crcTable=l,Y}var J,Ee;function We(){if(Ee)return J;Ee=1;const i=B;return J=function(e,{fs:a}){var E=e||"",g=l(),h=null;function l(){return{directory:!1,readonly:!1,hidden:!1,executable:!1,mtime:0,atime:0}}return E&&a.existsSync(E)?(h=a.statSync(E),g.directory=h.isDirectory(),g.mtime=h.mtime,g.atime=h.atime,g.executable=(73&h.mode)!==0,g.readonly=(128&h.mode)===0,g.hidden=i.basename(E)[0]==="."):console.warn("Invalid path: "+E),{get directory(){return g.directory},get readOnly(){return g.readonly},get hidden(){return g.hidden},get mtime(){return g.mtime},get atime(){return g.atime},get executable(){return g.executable},decodeAttributes:function(){},encodeAttributes:function(){},toJSON:function(){return{path:E,isDirectory:g.directory,isReadOnly:g.readonly,isHidden:g.hidden,isExecutable:g.executable,mTime:g.mtime,aTime:g.atime}},toString:function(){return JSON.stringify(this.toJSON(),null,"	")}}},J}var Q,me;function Xe(){return me||(me=1,Q={efs:!0,encode:i=>Buffer.from(i,"utf8"),decode:i=>i.toString("utf8")}),Q}var he;function V(){return he||(he=1,P.exports=Ve(),P.exports.Constants=Te(),P.exports.Errors=ce(),P.exports.FileAttr=We(),P.exports.decoder=Xe()),P.exports}var W={},ee,ge;function ke(){if(ge)return ee;ge=1;var i=V(),e=i.Constants;return ee=function(){var a=20,E=10,g=0,h=0,l=0,f=0,n=0,m=0,D=0,p=0,y=0,d=0,S=0,C=0,F=0;a|=i.isWin?2560:768,g|=e.FLG_EFS;const w={extraLen:0},L=o=>Math.max(0,o)>>>0,_=o=>Math.max(0,o)&255;return l=i.fromDate2DOS(new Date),{get made(){return a},set made(o){a=o},get version(){return E},set version(o){E=o},get flags(){return g},set flags(o){g=o},get flags_efs(){return(g&e.FLG_EFS)>0},set flags_efs(o){o?g|=e.FLG_EFS:g&=~e.FLG_EFS},get flags_desc(){return(g&e.FLG_DESC)>0},set flags_desc(o){o?g|=e.FLG_DESC:g&=~e.FLG_DESC},get method(){return h},set method(o){switch(o){case e.STORED:this.version=10;case e.DEFLATED:default:this.version=20}h=o},get time(){return i.fromDOS2Date(this.timeval)},set time(o){this.timeval=i.fromDate2DOS(o)},get timeval(){return l},set timeval(o){l=L(o)},get timeHighByte(){return _(l>>>8)},get crc(){return f},set crc(o){f=L(o)},get compressedSize(){return n},set compressedSize(o){n=L(o)},get size(){return m},set size(o){m=L(o)},get fileNameLength(){return D},set fileNameLength(o){D=o},get extraLength(){return p},set extraLength(o){p=o},get extraLocalLength(){return w.extraLen},set extraLocalLength(o){w.extraLen=o},get commentLength(){return y},set commentLength(o){y=o},get diskNumStart(){return d},set diskNumStart(o){d=L(o)},get inAttr(){return S},set inAttr(o){S=L(o)},get attr(){return C},set attr(o){C=L(o)},get fileAttr(){return(C||0)>>16&4095},get offset(){return F},set offset(o){F=L(o)},get encrypted(){return(g&e.FLG_ENC)===e.FLG_ENC},get centralHeaderSize(){return e.CENHDR+D+p+y},get realDataOffset(){return F+e.LOCHDR+w.fnameLen+w.extraLen},get localHeader(){return w},loadLocalHeaderFromBinary:function(o){var t=o.slice(F,F+e.LOCHDR);if(t.readUInt32LE(0)!==e.LOCSIG)throw i.Errors.INVALID_LOC();w.version=t.readUInt16LE(e.LOCVER),w.flags=t.readUInt16LE(e.LOCFLG),w.method=t.readUInt16LE(e.LOCHOW),w.time=t.readUInt32LE(e.LOCTIM),w.crc=t.readUInt32LE(e.LOCCRC),w.compressedSize=t.readUInt32LE(e.LOCSIZ),w.size=t.readUInt32LE(e.LOCLEN),w.fnameLen=t.readUInt16LE(e.LOCNAM),w.extraLen=t.readUInt16LE(e.LOCEXT);const c=F+e.LOCHDR+w.fnameLen,r=c+w.extraLen;return o.slice(c,r)},loadFromBinary:function(o){if(o.length!==e.CENHDR||o.readUInt32LE(0)!==e.CENSIG)throw i.Errors.INVALID_CEN();a=o.readUInt16LE(e.CENVEM),E=o.readUInt16LE(e.CENVER),g=o.readUInt16LE(e.CENFLG),h=o.readUInt16LE(e.CENHOW),l=o.readUInt32LE(e.CENTIM),f=o.readUInt32LE(e.CENCRC),n=o.readUInt32LE(e.CENSIZ),m=o.readUInt32LE(e.CENLEN),D=o.readUInt16LE(e.CENNAM),p=o.readUInt16LE(e.CENEXT),y=o.readUInt16LE(e.CENCOM),d=o.readUInt16LE(e.CENDSK),S=o.readUInt16LE(e.CENATT),C=o.readUInt32LE(e.CENATX),F=o.readUInt32LE(e.CENOFF)},localHeaderToBinary:function(){var o=Buffer.alloc(e.LOCHDR);return o.writeUInt32LE(e.LOCSIG,0),o.writeUInt16LE(E,e.LOCVER),o.writeUInt16LE(g,e.LOCFLG),o.writeUInt16LE(h,e.LOCHOW),o.writeUInt32LE(l,e.LOCTIM),o.writeUInt32LE(f,e.LOCCRC),o.writeUInt32LE(n,e.LOCSIZ),o.writeUInt32LE(m,e.LOCLEN),o.writeUInt16LE(D,e.LOCNAM),o.writeUInt16LE(w.extraLen,e.LOCEXT),o},centralHeaderToBinary:function(){var o=Buffer.alloc(e.CENHDR+D+p+y);return o.writeUInt32LE(e.CENSIG,0),o.writeUInt16LE(a,e.CENVEM),o.writeUInt16LE(E,e.CENVER),o.writeUInt16LE(g,e.CENFLG),o.writeUInt16LE(h,e.CENHOW),o.writeUInt32LE(l,e.CENTIM),o.writeUInt32LE(f,e.CENCRC),o.writeUInt32LE(n,e.CENSIZ),o.writeUInt32LE(m,e.CENLEN),o.writeUInt16LE(D,e.CENNAM),o.writeUInt16LE(p,e.CENEXT),o.writeUInt16LE(y,e.CENCOM),o.writeUInt16LE(d,e.CENDSK),o.writeUInt16LE(S,e.CENATT),o.writeUInt32LE(C,e.CENATX),o.writeUInt32LE(F,e.CENOFF),o},toJSON:function(){const o=function(t){return t+" bytes"};return{made:a,version:E,flags:g,method:i.methodToString(h),time:this.time,crc:"0x"+f.toString(16).toUpperCase(),compressedSize:o(n),size:o(m),fileNameLength:o(D),extraLength:o(p),commentLength:o(y),diskNumStart:d,inAttr:S,attr:C,offset:F,centralHeaderSize:o(e.CENHDR+D+p+y)}},toString:function(){return JSON.stringify(this.toJSON(),null,"	")}}},ee}var te,ye;function Ke(){if(ye)return te;ye=1;var i=V(),e=i.Constants;return te=function(){var a=0,E=0,g=0,h=0,l=0;return{get diskEntries(){return a},set diskEntries(f){a=E=f},get totalEntries(){return E},set totalEntries(f){E=a=f},get size(){return g},set size(f){g=f},get offset(){return h},set offset(f){h=f},get commentLength(){return l},set commentLength(f){l=f},get mainHeaderSize(){return e.ENDHDR+l},loadFromBinary:function(f){if((f.length!==e.ENDHDR||f.readUInt32LE(0)!==e.ENDSIG)&&(f.length<e.ZIP64HDR||f.readUInt32LE(0)!==e.ZIP64SIG))throw i.Errors.INVALID_END();f.readUInt32LE(0)===e.ENDSIG?(a=f.readUInt16LE(e.ENDSUB),E=f.readUInt16LE(e.ENDTOT),g=f.readUInt32LE(e.ENDSIZ),h=f.readUInt32LE(e.ENDOFF),l=f.readUInt16LE(e.ENDCOM)):(a=i.readBigUInt64LE(f,e.ZIP64SUB),E=i.readBigUInt64LE(f,e.ZIP64TOT),g=i.readBigUInt64LE(f,e.ZIP64SIZE),h=i.readBigUInt64LE(f,e.ZIP64OFF),l=0)},toBinary:function(){var f=Buffer.alloc(e.ENDHDR+l);return f.writeUInt32LE(e.ENDSIG,0),f.writeUInt32LE(0,4),f.writeUInt16LE(a,e.ENDSUB),f.writeUInt16LE(E,e.ENDTOT),f.writeUInt32LE(g,e.ENDSIZ),f.writeUInt32LE(h,e.ENDOFF),f.writeUInt16LE(l,e.ENDCOM),f.fill(" ",e.ENDHDR),f},toJSON:function(){const f=function(n,m){let D=n.toString(16).toUpperCase();for(;D.length<m;)D="0"+D;return"0x"+D};return{diskEntries:a,totalEntries:E,size:g+" bytes",offset:f(h,4),commentLength:l}},toString:function(){return JSON.stringify(this.toJSON(),null,"	")}}},te}var pe;function Ae(){return pe||(pe=1,W.EntryHeader=ke(),W.MainHeader=Ke()),W}var j={},re,Ie;function $e(){return Ie||(Ie=1,re=function(i){var e=Fe,a={chunkSize:(parseInt(i.length/1024)+1)*1024};return{deflate:function(){return e.deflateRawSync(i,a)},deflateAsync:function(E){var g=e.createDeflateRaw(a),h=[],l=0;g.on("data",function(f){h.push(f),l+=f.length}),g.on("end",function(){var f=Buffer.alloc(l),n=0;f.fill(0);for(var m=0;m<h.length;m++){var D=h[m];D.copy(f,n),n+=D.length}E&&E(f)}),g.end(i)}}}),re}var ne,De;function Ye(){if(De)return ne;De=1;const i=+(process.versions?process.versions.node:"").split(".")[0]||0;return ne=function(e,a){var E=Fe;const g=i>=15&&a>0?{maxOutputLength:a}:{};return{inflate:function(){return E.inflateRawSync(e,g)},inflateAsync:function(h){var l=E.createInflateRaw(g),f=[],n=0;l.on("data",function(m){f.push(m),n+=m.length}),l.on("end",function(){var m=Buffer.alloc(n),D=0;m.fill(0);for(var p=0;p<f.length;p++){var y=f[p];y.copy(m,D),D+=y.length}h&&h(m)}),l.end(e)}}},ne}var oe,Le;function Je(){if(Le)return oe;Le=1;const{randomFillSync:i}=Be,e=ce(),a=new Uint32Array(256).map((d,S)=>{for(let C=0;C<8;C++)(S&1)!==0?S=S>>>1^3988292384:S>>>=1;return S>>>0}),E=(d,S)=>Math.imul(d,S)>>>0,g=(d,S)=>a[(d^S)&255]^d>>>8,h=()=>typeof i=="function"?i(Buffer.alloc(12)):h.node();h.node=()=>{const d=Buffer.alloc(12),S=d.length;for(let C=0;C<S;C++)d[C]=Math.random()*256&255;return d};const l={genSalt:h};function f(d){const S=Buffer.isBuffer(d)?d:Buffer.from(d);this.keys=new Uint32Array([305419896,591751049,878082192]);for(let C=0;C<S.length;C++)this.updateKeys(S[C])}f.prototype.updateKeys=function(d){const S=this.keys;return S[0]=g(S[0],d),S[1]+=S[0]&255,S[1]=E(S[1],134775813)+1,S[2]=g(S[2],S[1]>>>24),d},f.prototype.next=function(){const d=(this.keys[2]|2)>>>0;return E(d,d^1)>>8&255};function n(d){const S=new f(d);return function(C){const F=Buffer.alloc(C.length);let w=0;for(let L of C)F[w++]=S.updateKeys(L^S.next());return F}}function m(d){const S=new f(d);return function(C,F,w=0){F||(F=Buffer.alloc(C.length));for(let L of C){const _=S.next();F[w++]=L^_,S.updateKeys(L)}return F}}function D(d,S,C){if(!d||!Buffer.isBuffer(d)||d.length<12)return Buffer.alloc(0);const F=n(C),w=F(d.slice(0,12)),L=(S.flags&8)===8?S.timeHighByte:S.crc>>>24;if(w[11]!==L)throw e.WRONG_PASSWORD();return F(d.slice(12))}function p(d){Buffer.isBuffer(d)&&d.length>=12?l.genSalt=function(){return d.slice(0,12)}:d==="node"?l.genSalt=h.node:l.genSalt=h}function y(d,S,C,F=!1){d==null&&(d=Buffer.alloc(0)),Buffer.isBuffer(d)||(d=Buffer.from(d.toString()));const w=m(C),L=l.genSalt();L[11]=S.crc>>>24&255,F&&(L[10]=S.crc>>>16&255);const _=Buffer.alloc(d.length+12);return w(L,_),w(d,_,12)}return oe={decrypt:D,encrypt:y,_salter:p},oe}var Se;function Qe(){return Se||(Se=1,j.Deflater=$e(),j.Inflater=Ye(),j.ZipCrypto=Je()),j}var ie,Ne;function Re(){if(Ne)return ie;Ne=1;var i=V(),e=Ae(),a=i.Constants,E=Qe();return ie=function(g,h){var l=new e.EntryHeader,f=Buffer.alloc(0),n=Buffer.alloc(0),m=!1,D=null,p=Buffer.alloc(0),y=Buffer.alloc(0),d=!0;const S=g,C=typeof S.decoder=="object"?S.decoder:i.decoder;d=C.hasOwnProperty("efs")?C.efs:!1;function F(){return!h||!(h instanceof Uint8Array)?Buffer.alloc(0):(y=l.loadLocalHeaderFromBinary(h),h.slice(l.realDataOffset,l.realDataOffset+l.compressedSize))}function w(r){if(l.flags_desc){const s={},u=l.realDataOffset+l.compressedSize;if(h.readUInt32LE(u)==a.LOCSIG||h.readUInt32LE(u)==a.CENSIG)throw i.Errors.DESCRIPTOR_NOT_EXIST();if(h.readUInt32LE(u)==a.EXTSIG)s.crc=h.readUInt32LE(u+a.EXTCRC),s.compressedSize=h.readUInt32LE(u+a.EXTSIZ),s.size=h.readUInt32LE(u+a.EXTLEN);else if(h.readUInt16LE(u+12)===19280)s.crc=h.readUInt32LE(u+a.EXTCRC-4),s.compressedSize=h.readUInt32LE(u+a.EXTSIZ-4),s.size=h.readUInt32LE(u+a.EXTLEN-4);else throw i.Errors.DESCRIPTOR_UNKNOWN();if(s.compressedSize!==l.compressedSize||s.size!==l.size||s.crc!==l.crc)throw i.Errors.DESCRIPTOR_FAULTY();if(i.crc32(r)!==s.crc)return!1}else if(i.crc32(r)!==l.localHeader.crc)return!1;return!0}function L(r,s,u){if(typeof s>"u"&&typeof r=="string"&&(u=r,r=void 0),m)return r&&s&&s(Buffer.alloc(0),i.Errors.DIRECTORY_CONTENT_ERROR()),Buffer.alloc(0);var N=F();if(N.length===0)return r&&s&&s(N),N;if(l.encrypted){if(typeof u!="string"&&!Buffer.isBuffer(u))throw i.Errors.INVALID_PASS_PARAM();N=E.ZipCrypto.decrypt(N,l,u)}var O=Buffer.alloc(l.size);switch(l.method){case i.Constants.STORED:if(N.copy(O),w(O))return r&&s&&s(O),O;throw r&&s&&s(O,i.Errors.BAD_CRC()),i.Errors.BAD_CRC();case i.Constants.DEFLATED:var T=new E.Inflater(N,l.size);if(r)T.inflateAsync(function(I){I.copy(I,0),s&&(w(I)?s(I):s(I,i.Errors.BAD_CRC()))});else{if(T.inflate(O).copy(O,0),!w(O))throw i.Errors.BAD_CRC(`"${C.decode(f)}"`);return O}break;default:throw r&&s&&s(Buffer.alloc(0),i.Errors.UNKNOWN_METHOD()),i.Errors.UNKNOWN_METHOD()}}function _(r,s){if((!D||!D.length)&&Buffer.isBuffer(h))return r&&s&&s(F()),F();if(D.length&&!m){var u;switch(l.method){case i.Constants.STORED:return l.compressedSize=l.size,u=Buffer.alloc(D.length),D.copy(u),r&&s&&s(u),u;default:case i.Constants.DEFLATED:var N=new E.Deflater(D);if(r)N.deflateAsync(function(T){u=Buffer.alloc(T.length),l.compressedSize=T.length,T.copy(u),s&&s(u)});else{var O=N.deflate();return l.compressedSize=O.length,O}N=null;break}}else if(r&&s)s(Buffer.alloc(0));else return Buffer.alloc(0)}function o(r,s){return(r.readUInt32LE(s+4)<<4)+r.readUInt32LE(s)}function t(r){try{for(var s=0,u,N,O;s+4<r.length;)u=r.readUInt16LE(s),s+=2,N=r.readUInt16LE(s),s+=2,O=r.slice(s,s+N),s+=N,a.ID_ZIP64===u&&c(O)}catch{throw i.Errors.EXTRA_FIELD_PARSE_ERROR()}}function c(r){var s,u,N,O;r.length>=a.EF_ZIP64_SCOMP&&(s=o(r,a.EF_ZIP64_SUNCOMP),l.size===a.EF_ZIP64_OR_32&&(l.size=s)),r.length>=a.EF_ZIP64_RHO&&(u=o(r,a.EF_ZIP64_SCOMP),l.compressedSize===a.EF_ZIP64_OR_32&&(l.compressedSize=u)),r.length>=a.EF_ZIP64_DSN&&(N=o(r,a.EF_ZIP64_RHO),l.offset===a.EF_ZIP64_OR_32&&(l.offset=N)),r.length>=a.EF_ZIP64_DSN+4&&(O=r.readUInt32LE(a.EF_ZIP64_DSN),l.diskNumStart===a.EF_ZIP64_OR_16&&(l.diskNumStart=O))}return{get entryName(){return C.decode(f)},get rawEntryName(){return f},set entryName(r){f=i.toBuffer(r,C.encode);var s=f[f.length-1];m=s===47||s===92,l.fileNameLength=f.length},get efs(){return typeof d=="function"?d(this.entryName):d},get extra(){return p},set extra(r){p=r,l.extraLength=r.length,t(r)},get comment(){return C.decode(n)},set comment(r){if(n=i.toBuffer(r,C.encode),l.commentLength=n.length,n.length>65535)throw i.Errors.COMMENT_TOO_LONG()},get name(){var r=C.decode(f);return m?r.substr(r.length-1).split("/").pop():r.split("/").pop()},get isDirectory(){return m},getCompressedData:function(){return _(!1,null)},getCompressedDataAsync:function(r){_(!0,r)},setData:function(r){D=i.toBuffer(r,i.decoder.encode),!m&&D.length?(l.size=D.length,l.method=i.Constants.DEFLATED,l.crc=i.crc32(r),l.changed=!0):l.method=i.Constants.STORED},getData:function(r){return l.changed?D:L(!1,null,r)},getDataAsync:function(r,s){l.changed?r(D):L(!0,r,s)},set attr(r){l.attr=r},get attr(){return l.attr},set header(r){l.loadFromBinary(r)},get header(){return l},packCentralHeader:function(){l.flags_efs=this.efs,l.extraLength=p.length;var r=l.centralHeaderToBinary(),s=i.Constants.CENHDR;return f.copy(r,s),s+=f.length,p.copy(r,s),s+=l.extraLength,n.copy(r,s),r},packLocalHeader:function(){let r=0;l.flags_efs=this.efs,l.extraLocalLength=y.length;const s=l.localHeaderToBinary(),u=Buffer.alloc(s.length+f.length+l.extraLocalLength);return s.copy(u,r),r+=s.length,f.copy(u,r),r+=f.length,y.copy(u,r),r+=y.length,u},toJSON:function(){const r=function(s){return"<"+(s&&s.length+" bytes buffer"||"null")+">"};return{entryName:this.entryName,name:this.name,comment:this.comment,isDirectory:this.isDirectory,header:l.toJSON(),compressedData:r(h),data:r(D)}},toString:function(){return JSON.stringify(this.toJSON(),null,"	")}}},ie}var se,Ce;function et(){if(Ce)return se;Ce=1;const i=Re(),e=Ae(),a=V();return se=function(E,g){var h=[],l={},f=Buffer.alloc(0),n=new e.MainHeader,m=!1;const D=new Set,p=g,{noSort:y,decoder:d}=p;E?F(p.readEntries):m=!0;function S(){const L=new Set;for(const _ of Object.keys(l)){const o=_.split("/");if(o.pop(),!!o.length)for(let t=0;t<o.length;t++){const c=o.slice(0,t+1).join("/")+"/";L.add(c)}}for(const _ of L)if(!(_ in l)){const o=new i(p);o.entryName=_,o.attr=16,o.temporary=!0,h.push(o),l[o.entryName]=o,D.add(o)}}function C(){if(m=!0,l={},n.diskEntries>(E.length-n.offset)/a.Constants.CENHDR)throw a.Errors.DISK_ENTRY_TOO_LARGE();h=new Array(n.diskEntries);for(var L=n.offset,_=0;_<h.length;_++){var o=L,t=new i(p,E);t.header=E.slice(o,o+=a.Constants.CENHDR),t.entryName=E.slice(o,o+=t.header.fileNameLength),t.header.extraLength&&(t.extra=E.slice(o,o+=t.header.extraLength)),t.header.commentLength&&(t.comment=E.slice(o,o+t.header.commentLength)),L+=t.header.centralHeaderSize,h[_]=t,l[t.entryName]=t}D.clear(),S()}function F(L){var _=E.length-a.Constants.ENDHDR,o=Math.max(0,_-65535),t=o,c=E.length,r=-1,s=0;for((typeof p.trailingSpace=="boolean"?p.trailingSpace:!1)&&(o=0),_;_>=t;_--)if(E[_]===80){if(E.readUInt32LE(_)===a.Constants.ENDSIG){r=_,s=_,c=_+a.Constants.ENDHDR,t=_-a.Constants.END64HDR;continue}if(E.readUInt32LE(_)===a.Constants.END64SIG){t=o;continue}if(E.readUInt32LE(_)===a.Constants.ZIP64SIG){r=_,c=_+a.readBigUInt64LE(E,_+a.Constants.ZIP64SIZE)+a.Constants.ZIP64LEAD;break}}if(r==-1)throw a.Errors.INVALID_FORMAT();n.loadFromBinary(E.slice(r,c)),n.commentLength&&(f=E.slice(s+a.Constants.ENDHDR)),L&&C()}function w(){h.length>1&&!y&&h.sort((L,_)=>L.entryName.toLowerCase().localeCompare(_.entryName.toLowerCase()))}return{get entries(){return m||C(),h.filter(L=>!D.has(L))},get comment(){return d.decode(f)},set comment(L){f=a.toBuffer(L,d.encode),n.commentLength=f.length},getEntryCount:function(){return m?h.length:n.diskEntries},forEach:function(L){this.entries.forEach(L)},getEntry:function(L){return m||C(),l[L]||null},setEntry:function(L){m||C(),h.push(L),l[L.entryName]=L,n.totalEntries=h.length},deleteFile:function(L,_=!0){m||C();const o=l[L];this.getEntryChildren(o,_).map(c=>c.entryName).forEach(this.deleteEntry)},deleteEntry:function(L){m||C();const _=l[L],o=h.indexOf(_);o>=0&&(h.splice(o,1),delete l[L],n.totalEntries=h.length)},getEntryChildren:function(L,_=!0){if(m||C(),typeof L=="object")if(L.isDirectory&&_){const o=[],t=L.entryName;for(const c of h)c.entryName.startsWith(t)&&o.push(c);return o}else return[L];return[]},getChildCount:function(L){if(L&&L.isDirectory){const _=this.getEntryChildren(L);return _.includes(L)?_.length-1:_.length}return 0},compressToBuffer:function(){m||C(),w();const L=[],_=[];let o=0,t=0;n.size=0,n.offset=0;let c=0;for(const u of this.entries){const N=u.getCompressedData();u.header.offset=t;const O=u.packLocalHeader(),T=O.length+N.length;t+=T,L.push(O),L.push(N);const I=u.packCentralHeader();_.push(I),n.size+=I.length,o+=T+I.length,c++}o+=n.mainHeaderSize,n.offset=t,n.totalEntries=c,t=0;const r=Buffer.alloc(o);for(const u of L)u.copy(r,t),t+=u.length;for(const u of _)u.copy(r,t),t+=u.length;const s=n.toBinary();return f&&f.copy(s,a.Constants.ENDHDR),s.copy(r,t),E=r,m=!1,r},toAsyncBuffer:function(L,_,o,t){try{m||C(),w();const c=[],r=[];let s=0,u=0,N=0;n.size=0,n.offset=0;const O=function(T){if(T.length>0){const I=T.shift(),x=I.entryName+I.extra.toString();o&&o(x),I.getCompressedDataAsync(function(R){t&&t(x),I.header.offset=u;const H=I.packLocalHeader(),M=H.length+R.length;u+=M,c.push(H),c.push(R);const Z=I.packCentralHeader();r.push(Z),n.size+=Z.length,s+=M+Z.length,N++,O(T)})}else{s+=n.mainHeaderSize,n.offset=u,n.totalEntries=N,u=0;const I=Buffer.alloc(s);c.forEach(function(R){R.copy(I,u),u+=R.length}),r.forEach(function(R){R.copy(I,u),u+=R.length});const x=n.toBinary();f&&f.copy(x,a.Constants.ENDHDR),x.copy(I,u),E=I,m=!1,L(I)}};O(Array.from(this.entries))}catch(c){_(c)}}}},se}var ae,_e;function tt(){if(_e)return ae;_e=1;const i=V(),e=B,a=Re(),E=et(),g=(...n)=>i.findLast(n,m=>typeof m=="boolean"),h=(...n)=>i.findLast(n,m=>typeof m=="string"),l=(...n)=>i.findLast(n,m=>typeof m=="function"),f={noSort:!1,readEntries:!1,method:i.Constants.NONE,fs:null};return ae=function(n,m){let D=null;const p=Object.assign(Object.create(null),f);n&&typeof n=="object"&&(n instanceof Uint8Array||(Object.assign(p,n),n=p.input?p.input:void 0,p.input&&delete p.input),Buffer.isBuffer(n)&&(D=n,p.method=i.Constants.BUFFER,n=void 0)),Object.assign(p,m);const y=new i(p);if((typeof p.decoder!="object"||typeof p.decoder.encode!="function"||typeof p.decoder.decode!="function")&&(p.decoder=i.decoder),n&&typeof n=="string")if(y.fs.existsSync(n))p.method=i.Constants.FILE,p.filename=n,D=y.fs.readFileSync(n);else throw i.Errors.INVALID_FILENAME();const d=new E(D,p),{canonical:S,sanitize:C,zipnamefix:F}=i;function w(t){if(t&&d){var c;if(typeof t=="string"&&(c=d.getEntry(e.posix.normalize(t))),typeof t=="object"&&typeof t.entryName<"u"&&typeof t.header<"u"&&(c=d.getEntry(t.entryName)),c)return c}return null}function L(t){const{join:c,normalize:r,sep:s}=e.posix;return c(".",r(s+t.split("\\").join(s)+s))}function _(t){return t instanceof RegExp?(function(c){return function(r){return c.test(r)}})(t):typeof t!="function"?()=>!0:t}const o=(t,c)=>{let r=c.slice(-1);return r=r===y.sep?y.sep:"",e.relative(t,c)+r};return{readFile:function(t,c){var r=w(t);return r&&r.getData(c)||null},childCount:function(t){const c=w(t);if(c)return d.getChildCount(c)},readFileAsync:function(t,c){var r=w(t);r?r.getDataAsync(c):c(null,"getEntry failed for:"+t)},readAsText:function(t,c){var r=w(t);if(r){var s=r.getData();if(s&&s.length)return s.toString(c||"utf8")}return""},readAsTextAsync:function(t,c,r){var s=w(t);s?s.getDataAsync(function(u,N){if(N){c(u,N);return}u&&u.length?c(u.toString(r||"utf8")):c("")}):c("")},deleteFile:function(t,c=!0){var r=w(t);r&&d.deleteFile(r.entryName,c)},deleteEntry:function(t){var c=w(t);c&&d.deleteEntry(c.entryName)},addZipComment:function(t){d.comment=t},getZipComment:function(){return d.comment||""},addZipEntryComment:function(t,c){var r=w(t);r&&(r.comment=c)},getZipEntryComment:function(t){var c=w(t);return c&&c.comment||""},updateFile:function(t,c){var r=w(t);r&&r.setData(c)},addLocalFile:function(t,c,r,s){if(y.fs.existsSync(t)){c=c?L(c):"";const u=e.win32.basename(e.win32.normalize(t));c+=r||u;const N=y.fs.statSync(t),O=N.isFile()?y.fs.readFileSync(t):Buffer.alloc(0);N.isDirectory()&&(c+=y.sep),this.addFile(c,O,s,N)}else throw i.Errors.FILE_NOT_FOUND(t)},addLocalFileAsync:function(t,c){t=typeof t=="object"?t:{localPath:t};const r=e.resolve(t.localPath),{comment:s}=t;let{zipPath:u,zipName:N}=t;const O=this;y.fs.stat(r,function(T,I){if(T)return c(T,!1);u=u?L(u):"";const x=e.win32.basename(e.win32.normalize(r));if(u+=N||x,I.isFile())y.fs.readFile(r,function(R,H){return R?c(R,!1):(O.addFile(u,H,s,I),setImmediate(c,void 0,!0))});else if(I.isDirectory())return u+=y.sep,O.addFile(u,Buffer.alloc(0),s,I),setImmediate(c,void 0,!0)})},addLocalFolder:function(t,c,r){if(r=_(r),c=c?L(c):"",t=e.normalize(t),y.fs.existsSync(t)){const s=y.findFiles(t),u=this;if(s.length)for(const N of s){const O=e.join(c,o(t,N));r(O)&&u.addLocalFile(N,e.dirname(O))}}else throw i.Errors.FILE_NOT_FOUND(t)},addLocalFolderAsync:function(t,c,r,s){s=_(s),r=r?L(r):"",t=e.normalize(t);var u=this;y.fs.open(t,"r",function(N){if(N&&N.code==="ENOENT")c(void 0,i.Errors.FILE_NOT_FOUND(t));else if(N)c(void 0,N);else{var O=y.findFiles(t),T=-1,I=function(){if(T+=1,T<O.length){var x=O[T],R=o(t,x).split("\\").join("/");R=R.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\x20-\x7E]/g,""),s(R)?y.fs.stat(x,function(H,M){H&&c(void 0,H),M.isFile()?y.fs.readFile(x,function(Z,z){Z?c(void 0,Z):(u.addFile(r+R,z,"",M),I())}):(u.addFile(r+R+"/",Buffer.alloc(0),"",M),I())}):process.nextTick(()=>{I()})}else c(!0,void 0)};I()}})},addLocalFolderAsync2:function(t,c){const r=this;t=typeof t=="object"?t:{localPath:t},localPath=e.resolve(L(t.localPath));let{zipPath:s,filter:u,namefix:N}=t;u instanceof RegExp?u=(function(I){return function(x){return I.test(x)}})(u):typeof u!="function"&&(u=function(){return!0}),s=s?L(s):"",N=="latin1"&&(N=I=>I.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\x20-\x7E]/g,"")),typeof N!="function"&&(N=I=>I);const O=I=>e.join(s,N(o(localPath,I))),T=I=>e.win32.basename(e.win32.normalize(N(I)));y.fs.open(localPath,"r",function(I){I&&I.code==="ENOENT"?c(void 0,i.Errors.FILE_NOT_FOUND(localPath)):I?c(void 0,I):y.findFilesAsync(localPath,function(x,R){if(x)return c(x);R=R.filter(H=>u(O(H))),R.length||c(void 0,!1),setImmediate(R.reverse().reduce(function(H,M){return function(Z,z){if(Z||z===!1)return setImmediate(H,Z,!1);r.addLocalFileAsync({localPath:M,zipPath:e.dirname(O(M)),zipName:T(M)},H)}},c))})})},addLocalFolderPromise:function(t,c){return new Promise((r,s)=>{this.addLocalFolderAsync2(Object.assign({localPath:t},c),(u,N)=>{u&&s(u),N&&r(this)})})},addFile:function(t,c,r,s){t=F(t);let u=w(t);const N=u!=null;N||(u=new a(p),u.entryName=t),u.comment=r||"";const O=typeof s=="object"&&s instanceof y.fs.Stats;O&&(u.header.time=s.mtime);var T=u.isDirectory?16:0;let I=u.isDirectory?16384:32768;return O?I|=4095&s.mode:typeof s=="number"?I|=4095&s:I|=u.isDirectory?493:420,T=(T|I<<16)>>>0,u.attr=T,u.setData(c),N||d.setEntry(u),u},getEntries:function(t){return d.password=t,d?d.entries:[]},getEntry:function(t){return w(t)},getEntryCount:function(){return d.getEntryCount()},forEach:function(t){return d.forEach(t)},extractEntryTo:function(t,c,r,s,u,N){s=g(!1,s),u=g(!1,u),r=g(!0,r),N=h(u,N);var O=w(t);if(!O)throw i.Errors.NO_ENTRY();var T=S(O.entryName),I=C(c,N&&!O.isDirectory?N:r?T:e.basename(T));if(O.isDirectory){var x=d.getEntryChildren(O);return x.forEach(function(M){if(M.isDirectory)return;var Z=M.getData();if(!Z)throw i.Errors.CANT_EXTRACT_FILE();var z=S(M.entryName),X=C(c,r?z:e.basename(z));const k=u?M.header.fileAttr:void 0;y.writeFileTo(X,Z,s,k)}),!0}var R=O.getData(d.password);if(!R)throw i.Errors.CANT_EXTRACT_FILE();if(y.fs.existsSync(I)&&!s)throw i.Errors.CANT_OVERRIDE();const H=u?t.header.fileAttr:void 0;return y.writeFileTo(I,R,s,H),!0},test:function(t){if(!d)return!1;for(var c in d.entries)try{if(c.isDirectory)continue;var r=d.entries[c].getData(t);if(!r)return!1}catch{return!1}return!0},extractAllTo:function(t,c,r,s){if(r=g(!1,r),s=h(r,s),c=g(!1,c),!d)throw i.Errors.NO_ZIP();d.entries.forEach(function(u){var N=C(t,S(u.entryName));if(u.isDirectory){y.makeDir(N);return}var O=u.getData(s);if(!O)throw i.Errors.CANT_EXTRACT_FILE();const T=r?u.header.fileAttr:void 0;y.writeFileTo(N,O,c,T);try{y.fs.utimesSync(N,u.header.time,u.header.time)}catch{throw i.Errors.CANT_EXTRACT_FILE()}})},extractAllToAsync:function(t,c,r,s){if(s=l(c,r,s),r=g(!1,r),c=g(!1,c),!s)return new Promise((I,x)=>{this.extractAllToAsync(t,c,r,function(R){R?x(R):I(this)})});if(!d){s(i.Errors.NO_ZIP());return}t=e.resolve(t);const u=I=>C(t,e.normalize(S(I.entryName))),N=(I,x)=>new Error(I+': "'+x+'"'),O=[],T=[];d.entries.forEach(I=>{I.isDirectory?O.push(I):T.push(I)});for(const I of O){const x=u(I),R=r?I.header.fileAttr:void 0;try{y.makeDir(x),R&&y.fs.chmodSync(x,R),y.fs.utimesSync(x,I.header.time,I.header.time)}catch{s(N("Unable to create folder",x))}}T.reverse().reduce(function(I,x){return function(R){if(R)I(R);else{const H=e.normalize(S(x.entryName)),M=C(t,H);x.getDataAsync(function(Z,z){if(z)I(z);else if(!Z)I(i.Errors.CANT_EXTRACT_FILE());else{const X=r?x.header.fileAttr:void 0;y.writeFileToAsync(M,Z,c,X,function(k){k||I(N("Unable to write file",M)),y.fs.utimes(M,x.header.time,x.header.time,function(ve){ve?I(N("Unable to set times",M)):I()})})}})}}},s)()},writeZip:function(t,c){if(arguments.length===1&&typeof t=="function"&&(c=t,t=""),!t&&p.filename&&(t=p.filename),!!t){var r=d.compressToBuffer();if(r){var s=y.writeFileTo(t,r,!0);typeof c=="function"&&c(s?null:new Error("failed"),"")}}},writeZipPromise:function(t,c){const{overwrite:r,perm:s}=Object.assign({overwrite:!0},c);return new Promise((u,N)=>{!t&&p.filename&&(t=p.filename),t||N("ADM-ZIP: ZIP File Name Missing"),this.toBufferPromise().then(O=>{const T=I=>I?u(I):N("ADM-ZIP: Wasn't able to write zip file");y.writeFileToAsync(t,O,r,s,T)},N)})},toBufferPromise:function(){return new Promise((t,c)=>{d.toAsyncBuffer(t,c)})},toBuffer:function(t,c,r,s){return typeof t=="function"?(d.toAsyncBuffer(t,c,r,s),null):d.compressToBuffer()}}},ae}var rt=tt();const we=qe(rt);function nt(){A.ipcMain.handle("ucp-read-file",async(i,e)=>{try{return b.promises.readFile(e,"utf-8")}catch(a){throw console.error("Failed to read file:",a),a}}),A.ipcMain.handle("ucp-read-binary",async(i,e)=>{try{return b.promises.readFile(e)}catch(a){throw console.error("Failed to read binary file:",a),a}}),A.ipcMain.handle("ucp-get-stats",async(i,e)=>{try{const a=await b.promises.stat(e);return{size:a.size,mtime:a.mtime}}catch{return null}}),A.ipcMain.handle("ucp-zip-folder",async(i,e,a)=>{try{if(!b.existsSync(e))throw new Error("Folder does not exist");const E=new we;return E.addLocalFolder(e),a?(E.writeZip(a),a):E.toBuffer()}catch(E){throw console.error("Failed to zip folder:",E),E}}),A.ipcMain.handle("ucp-backup-file",async(i,e)=>{try{if(b.existsSync(e)){const a=e+".bak";return await b.promises.rename(e,a),!0}return!1}catch(a){throw console.error("Back up failed:",a),a}}),A.ipcMain.handle("ucp-restore-file",async(i,e)=>{try{const a=e+".bak";return b.existsSync(a)?(b.existsSync(e)&&await b.promises.unlink(e),await b.promises.rename(a,e),!0):!1}catch(a){throw console.error("Restore failed:",a),a}}),A.ipcMain.handle("ucp-write-file",async(i,e,a)=>{try{const E=B.dirname(e);return b.existsSync(E)||await b.promises.mkdir(E,{recursive:!0}),await b.promises.writeFile(e,a),!0}catch(E){throw console.error("Write failed:",E),E}}),A.ipcMain.handle("ucp-unzip",async(i,e,a)=>{try{return new we(e).extractAllTo(a,!0),!0}catch(E){throw console.error("Unzip failed:",E),E}}),A.ipcMain.handle("ucp-delete-file",async(i,e)=>{try{return b.existsSync(e)?((await b.promises.stat(e)).isDirectory()?await b.promises.rm(e,{recursive:!0,force:!0}):await b.promises.unlink(e),!0):!1}catch(a){throw console.error("Delete failed:",a),a}})}Ge();je();He();Ze();nt();process.env.DIST=B.join(__dirname,"../dist");process.env.VITE_PUBLIC=A.app.isPackaged?process.env.DIST:B.join(process.env.DIST,"../public");let G;const Oe=process.env.VITE_DEV_SERVER_URL;function xe(){const i=process.env.VITE_PUBLIC||"";G=new A.BrowserWindow({width:1200,height:800,icon:B.join(i,"electron-vite.svg"),webPreferences:{preload:B.join(__dirname,"preload.js"),nodeIntegration:!0,contextIsolation:!0},backgroundColor:"#1a1a1a",titleBarStyle:"hidden",titleBarOverlay:{color:"#1a1a1a",symbolColor:"#ffffff",height:30}}),Pe(G),G.webContents.on("did-finish-load",()=>{G?.webContents.send("main-process-message",new Date().toLocaleString())}),Oe?(G.loadURL(Oe),G.webContents.openDevTools()):G.loadFile(B.join(process.env.DIST||"","index.html"))}A.app.on("window-all-closed",()=>{process.platform!=="darwin"&&A.app.quit()});A.app.on("activate",()=>{A.BrowserWindow.getAllWindows().length===0&&xe()});A.app.whenReady().then(xe);
