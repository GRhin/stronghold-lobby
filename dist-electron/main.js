"use strict";const a=require("electron"),d=require("path"),b=require("child_process"),g=require("fs"),S=require("steamworks.js"),I=require("stream/promises"),v=require("stream");let r=null,l=null;function M(){try{r=S.init(40970),console.log("Steam initialized:",r.localplayer.getName()),console.log("Client keys:",Object.keys(r)),console.log("Localplayer keys:",Object.keys(r.localplayer))}catch(t){console.error("Failed to initialize Steam:",t)}}function k(){a.ipcMain.handle("get-steam-user",()=>r?{name:r.localplayer.getName(),steamId:r.localplayer.getSteamId().steamId64.toString()}:null),a.ipcMain.handle("get-auth-ticket",async()=>{if(!r)throw new Error("Steam not initialized");try{return(await r.auth.getAuthTicketForWebApi("LobbyClient")).getBytes().toString("hex")}catch(t){return console.error("Failed to get auth ticket:",t),null}}),a.ipcMain.handle("get-steam-friends",()=>r?r.friends?r.friends.getFriends(4).map(e=>({id:e.getSteamId().steamId64.toString(),name:e.getName(),status:e.getPersonaState(),avatar:e.getMediumAvatarUrl()})):(console.warn("Steam Friends interface not available in this version of steamworks.js"),[{id:"76561198000000001",name:"Sir William (Mock)",status:1,avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=William"},{id:"76561198000000002",name:"The Snake (Mock)",status:6,avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=Snake"},{id:"76561198000000003",name:"The Rat (Mock)",status:0,avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=Rat"}]):[]),a.ipcMain.handle("steam-create-lobby",async(t,e=8,s="Lobby",i="crusader")=>{if(!r)throw new Error("Steam not initialized");try{return l=await r.matchmaking.createLobby(2,e),console.log("Created lobby:",l.id),l.setData("name",s)||console.warn("Failed to set lobby name"),l.setData("gameMode",i)||console.warn("Failed to set game mode"),{id:l.id.toString(),owner:l.getOwner().steamId64.toString(),name:s,gameMode:i}}catch(n){throw console.error("Failed to create lobby:",n),n}}),a.ipcMain.handle("steam-get-lobbies",async()=>{if(!r)return[];try{return(await r.matchmaking.getLobbies()).map(e=>({id:e.id.toString(),memberCount:e.getMemberCount(),maxMembers:e.getMemberLimit(),name:e.getData("name")||"Unnamed Lobby",gameMode:e.getData("gameMode")||"crusader"}))}catch(t){return console.error("Failed to get lobbies:",t),[]}}),a.ipcMain.handle("steam-join-lobby",async(t,e)=>{if(!r)throw new Error("Steam not initialized");try{return console.log("Joining lobby:",e),l=await r.matchmaking.joinLobby(BigInt(e)),{id:l.id.toString(),owner:l.getOwner().steamId64.toString()}}catch(s){throw console.error("Failed to join lobby:",s),s}}),a.ipcMain.handle("steam-leave-lobby",async()=>{l&&(console.log("Leaving lobby:",l.id),await l.leave(),l=null)}),a.ipcMain.handle("steam-get-lobby-members",async()=>{if(!l)return[];try{return l.getMembers().map(e=>{let s=e.steamId64.toString();const i=e.steamId64;if(r.localplayer&&i===r.localplayer.getSteamId().steamId64)s=r.localplayer.getName();else if(r.friends)try{s=r.friends.getFriend(i).getName()}catch{}return{id:i.toString(),name:s}})}catch(t){return console.error("Failed to get lobby members:",t),[]}})}function x(){if(!r)return console.error("getGameInstallDir: Client is null"),null;try{console.log("getGameInstallDir: Attempting to get install dir for 40970");const t=r.apps.appInstallDir(40970);return console.log("getGameInstallDir: Result:",t),t}catch(t){return console.error("getGameInstallDir: Failed to get install dir:",t),null}}let p=null;function D(t){p=t}function E(){a.ipcMain.handle("select-game-path",async()=>{const t=await a.dialog.showOpenDialog({properties:["openFile"],filters:[{name:"Executables",extensions:["exe"]}]});return!t.canceled&&t.filePaths.length>0?t.filePaths[0]:null}),a.ipcMain.handle("launch-game",async(t,e,s)=>{if(!g.existsSync(e))throw new Error("Game executable not found");const i=s.split(" ").filter(o=>o.length>0),n=d.dirname(e);console.log(`Launching game: "${e}" with args: ${i} in ${n}`);try{const o=b.spawn(`"${e}"`,i,{cwd:n,detached:!0,shell:!0,windowsVerbatimArguments:!0});return o.on("error",c=>{console.error("Failed to start game:",c)}),o.on("close",c=>{console.log(`Game process closed with code ${c}`),p&&p.webContents.send("game-exited",c)}),o.unref(),{success:!0}}catch(o){return console.error("Launch error:",o),{success:!1,error:o.message}}}),a.ipcMain.handle("launch-steam-game",async(t,e,s="crusader")=>{console.log("Attempting to auto-detect game path...");const i=x();if(!i){console.error("Could not detect game install directory");const h=`steam://run/40970//${encodeURIComponent(e).replace(/%2B/g,"+")}`;console.log("Fallback to Steam URL:",h);try{return await a.shell.openExternal(h),{success:!0}}catch(y){return{success:!1,error:y.message}}}const n=s==="extreme"?"Stronghold_Crusader_Extreme.exe":"Stronghold Crusader.exe",o=d.join(i,n);if(console.log("Auto-detected game path:",o,"(Mode:",s,")"),!g.existsSync(o))return console.error("Executable not found at:",o),{success:!1,error:`Executable not found: ${n}`};const c=e.split(" ").filter(u=>u.length>0);c.push("--ucp-verbosity 10"),c.push("--ucp-no-security"),console.log("Launching with arguments:",e,"-> Array:",c);try{return b.spawn(`"${o}"`,c,{cwd:i,detached:!0,shell:!0,windowsVerbatimArguments:!0}).unref(),{success:!0}}catch(u){return console.error("Launch error:",u),{success:!1,error:u.message}}})}function L(){a.ipcMain.handle("download-file",async(t,e,s,i)=>{try{console.log(`Starting download: ${e} -> ${s}`);let n="";i==="maps"?n=d.join(a.app.getPath("documents"),"Stronghold Crusader","Maps"):i==="ucp"?n=d.join(a.app.getPath("userData"),"UCP"):n=d.join(a.app.getPath("downloads")),g.existsSync(n)||g.mkdirSync(n,{recursive:!0});const o=d.join(n,s),c=await fetch(e);if(!c.ok)throw new Error(`Failed to fetch ${e}: ${c.statusText}`);if(!c.body)throw new Error("No response body");const u=v.Readable.fromWeb(c.body);return await I.pipeline(u,g.createWriteStream(o)),console.log(`Download complete: ${o}`),{success:!0,path:o}}catch(n){return console.error("Download error:",n),{success:!1,error:n.message}}})}E();L();M();k();process.env.DIST=d.join(__dirname,"../dist");process.env.VITE_PUBLIC=a.app.isPackaged?process.env.DIST:d.join(process.env.DIST,"../public");let m;const f=process.env.VITE_DEV_SERVER_URL;function w(){const t=process.env.VITE_PUBLIC||"";m=new a.BrowserWindow({width:1200,height:800,icon:d.join(t,"electron-vite.svg"),webPreferences:{preload:d.join(__dirname,"preload.js"),nodeIntegration:!0,contextIsolation:!0},backgroundColor:"#1a1a1a",titleBarStyle:"hidden",titleBarOverlay:{color:"#1a1a1a",symbolColor:"#ffffff",height:30}}),D(m),m.webContents.on("did-finish-load",()=>{m?.webContents.send("main-process-message",new Date().toLocaleString())}),f?(m.loadURL(f),m.webContents.openDevTools()):m.loadFile(d.join(process.env.DIST||"","index.html"))}a.app.on("window-all-closed",()=>{process.platform!=="darwin"&&a.app.quit()});a.app.on("activate",()=>{a.BrowserWindow.getAllWindows().length===0&&w()});a.app.whenReady().then(w);
