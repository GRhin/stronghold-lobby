"use strict";const a=require("electron"),d=require("path"),b=require("child_process"),g=require("fs"),S=require("steamworks.js"),I=require("stream/promises"),M=require("stream");let r=null,s=null;function v(){try{r=S.init(40970),console.log("Steam initialized:",r.localplayer.getName()),console.log("Client keys:",Object.keys(r)),console.log("Localplayer keys:",Object.keys(r.localplayer))}catch(t){console.error("Failed to initialize Steam:",t)}}function D(){a.ipcMain.handle("get-steam-user",()=>r?{name:r.localplayer.getName(),steamId:r.localplayer.getSteamId().steamId64.toString()}:null),a.ipcMain.handle("get-auth-ticket",async()=>{if(!r)throw new Error("Steam not initialized");try{return(await r.auth.getAuthTicketForWebApi("LobbyClient")).getBytes().toString("hex")}catch(t){return console.error("Failed to get auth ticket:",t),null}}),a.ipcMain.handle("get-steam-friends",()=>r?r.friends?r.friends.getFriends(4).map(e=>({id:e.getSteamId().steamId64.toString(),name:e.getName(),status:e.getPersonaState(),avatar:e.getMediumAvatarUrl()})):(console.warn("Steam Friends interface not available in this version of steamworks.js"),[{id:"76561198000000001",name:"Sir William (Mock)",status:1,avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=William"},{id:"76561198000000002",name:"The Snake (Mock)",status:6,avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=Snake"},{id:"76561198000000003",name:"The Rat (Mock)",status:0,avatar:"https://api.dicebear.com/7.x/avataaars/svg?seed=Rat"}]):[]),a.ipcMain.handle("steam-create-lobby",async(t,e=8,i="Lobby",l="crusader")=>{if(!r)throw new Error("Steam not initialized");try{return s=await r.matchmaking.createLobby(2,e),console.log("Created lobby:",s.id),s.setData("name",i)||console.warn("Failed to set lobby name"),s.setData("gameMode",l)||console.warn("Failed to set game mode"),{id:s.id.toString(),owner:s.getOwner().steamId64.toString(),name:i,gameMode:l}}catch(n){throw console.error("Failed to create lobby:",n),n}}),a.ipcMain.handle("steam-get-lobbies",async()=>{if(!r)return[];try{return(await r.matchmaking.getLobbies()).map(e=>({id:e.id.toString(),memberCount:e.getMemberCount(),maxMembers:e.getMemberLimit(),name:e.getData("name")||"Unnamed Lobby",gameMode:e.getData("gameMode")||"crusader"}))}catch(t){return console.error("Failed to get lobbies:",t),[]}}),a.ipcMain.handle("steam-join-lobby",async(t,e)=>{if(!r)throw new Error("Steam not initialized");try{return console.log("Joining lobby:",e),s=await r.matchmaking.joinLobby(BigInt(e)),{id:s.id.toString(),owner:s.getOwner().steamId64.toString()}}catch(i){throw console.error("Failed to join lobby:",i),i}}),a.ipcMain.handle("steam-leave-lobby",async()=>{s&&(console.log("Leaving lobby:",s.id),await s.leave(),s=null)}),a.ipcMain.handle("steam-get-lobby-members",async()=>{if(!s)return[];try{const t=s.getMembers(),e=[];for(const i of t){const l=i.steamId64;let n=l.toString();if(r.localplayer&&l===r.localplayer.getSteamId().steamId64)n=r.localplayer.getName();else{s.requestLobbyMemberData(l);const o=s.getMemberData(l,"name");o&&(n=o)}e.push({id:l.toString(),name:n})}return e}catch(t){return console.error("Failed to get lobby members:",t),[]}}),a.ipcMain.handle("steam-send-lobby-chat",async(t,e)=>{if(!s)throw new Error("Not in a lobby");try{const i=s.sendChatMsg(e);return i||console.error("Failed to send lobby chat message"),i}catch(i){throw console.error("Error sending lobby chat:",i),i}}),a.ipcMain.handle("steam-setup-lobby-chat-listener",async()=>{if(!s||!r)return!1;try{return r.matchmaking.on("lobby-chat-message",(t,e,i)=>{if(s&&t.toString()===s.id.toString()){let l=e.steamId64.toString();if(r.localplayer&&e.steamId64===r.localplayer.getSteamId().steamId64)l=r.localplayer.getName();else{s.requestLobbyMemberData(e.steamId64);const o=s.getMemberData(e.steamId64,"name");o&&(l=o)}const n=a.BrowserWindow.getAllWindows();n.length>0&&n[0].webContents.send("lobby-chat-message",{senderId:e.steamId64.toString(),senderName:l,message:i,timestamp:new Date().toISOString()})}}),!0}catch(t){return console.error("Error setting up lobby chat listener:",t),!1}})}function k(){if(!r)return console.error("getGameInstallDir: Client is null"),null;try{console.log("getGameInstallDir: Attempting to get install dir for 40970");const t=r.apps.appInstallDir(40970);return console.log("getGameInstallDir: Result:",t),t}catch(t){return console.error("getGameInstallDir: Failed to get install dir:",t),null}}let h=null;function x(t){h=t}function E(){a.ipcMain.handle("select-game-path",async()=>{const t=await a.dialog.showOpenDialog({properties:["openFile"],filters:[{name:"Executables",extensions:["exe"]}]});return!t.canceled&&t.filePaths.length>0?t.filePaths[0]:null}),a.ipcMain.handle("launch-game",async(t,e,i)=>{if(!g.existsSync(e))throw new Error("Game executable not found");const l=i.split(" ").filter(o=>o.length>0),n=d.dirname(e);console.log(`Launching game: "${e}" with args: ${l} in ${n}`);try{const o=b.spawn(`"${e}"`,l,{cwd:n,detached:!0,shell:!0,windowsVerbatimArguments:!0});return o.on("error",c=>{console.error("Failed to start game:",c)}),o.on("close",c=>{console.log(`Game process closed with code ${c}`),h&&h.webContents.send("game-exited",c)}),o.unref(),{success:!0}}catch(o){return console.error("Launch error:",o),{success:!1,error:o.message}}}),a.ipcMain.handle("launch-steam-game",async(t,e,i="crusader")=>{console.log("Attempting to auto-detect game path...");const l=k();if(!l){console.error("Could not detect game install directory");const p=`steam://run/40970//${encodeURIComponent(e).replace(/%2B/g,"+")}`;console.log("Fallback to Steam URL:",p);try{return await a.shell.openExternal(p),{success:!0}}catch(f){return{success:!1,error:f.message}}}const n=i==="extreme"?"Stronghold_Crusader_Extreme.exe":"Stronghold Crusader.exe",o=d.join(l,n);if(console.log("Auto-detected game path:",o,"(Mode:",i,")"),!g.existsSync(o))return console.error("Executable not found at:",o),{success:!1,error:`Executable not found: ${n}`};const c=e.split(" ").filter(m=>m.length>0);c.push("--ucp-verbosity 10"),c.push("--ucp-no-security"),console.log("Launching with arguments:",e,"-> Array:",c);try{return b.spawn(`"${o}"`,c,{cwd:l,detached:!0,shell:!0,windowsVerbatimArguments:!0}).unref(),{success:!0}}catch(m){return console.error("Launch error:",m),{success:!1,error:m.message}}})}function C(){a.ipcMain.handle("download-file",async(t,e,i,l)=>{try{console.log(`Starting download: ${e} -> ${i}`);let n="";l==="maps"?n=d.join(a.app.getPath("documents"),"Stronghold Crusader","Maps"):l==="ucp"?n=d.join(a.app.getPath("userData"),"UCP"):n=d.join(a.app.getPath("downloads")),g.existsSync(n)||g.mkdirSync(n,{recursive:!0});const o=d.join(n,i),c=await fetch(e);if(!c.ok)throw new Error(`Failed to fetch ${e}: ${c.statusText}`);if(!c.body)throw new Error("No response body");const m=M.Readable.fromWeb(c.body);return await I.pipeline(m,g.createWriteStream(o)),console.log(`Download complete: ${o}`),{success:!0,path:o}}catch(n){return console.error("Download error:",n),{success:!1,error:n.message}}})}E();C();v();D();process.env.DIST=d.join(__dirname,"../dist");process.env.VITE_PUBLIC=a.app.isPackaged?process.env.DIST:d.join(process.env.DIST,"../public");let u;const w=process.env.VITE_DEV_SERVER_URL;function y(){const t=process.env.VITE_PUBLIC||"";u=new a.BrowserWindow({width:1200,height:800,icon:d.join(t,"electron-vite.svg"),webPreferences:{preload:d.join(__dirname,"preload.js"),nodeIntegration:!0,contextIsolation:!0},backgroundColor:"#1a1a1a",titleBarStyle:"hidden",titleBarOverlay:{color:"#1a1a1a",symbolColor:"#ffffff",height:30}}),x(u),u.webContents.on("did-finish-load",()=>{u?.webContents.send("main-process-message",new Date().toLocaleString())}),w?(u.loadURL(w),u.webContents.openDevTools()):(u.loadFile(d.join(process.env.DIST||"","index.html")),u.webContents.openDevTools())}a.app.on("window-all-closed",()=>{process.platform!=="darwin"&&a.app.quit()});a.app.on("activate",()=>{a.BrowserWindow.getAllWindows().length===0&&y()});a.app.whenReady().then(y);
